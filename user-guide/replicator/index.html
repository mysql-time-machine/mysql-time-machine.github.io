<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Replicator - MySQL Time Machine</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Replicator";
    var mkdocs_page_input_path = "user-guide/replicator.md";
    var mkdocs_page_url = "/user-guide/replicator/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> MySQL Time Machine</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>User Guide</span></li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Replicator</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#replicator">Replicator</a></li>
                
                    <li><a class="toctree-l4" href="#overview">Overview</a></li>
                
                    <li><a class="toctree-l4" href="#running-minimal-configuration">Running Minimal Configuration:</a></li>
                
                    <li><a class="toctree-l4" href="#additional-configuration-options">Additional Configuration Options</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../snapshotter/">Snapshotter</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../validator/">Validator</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../../about/">About</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">MySQL Time Machine</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>User Guide &raquo;</li>
        
      
    
    <li>Replicator</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="replicator">Replicator</h2>
<h3 id="overview">Overview</h3>
<p>Replicates data changes from MySQL binlog to HBase or Kafka. In case of HBase it preserves the previous data versions. HBase version is intended for auditing of historical data. In addition can maintain special daily-changes tables which are convenient for fast and cheap imports from HBase to Hive. Kafka version is intended for processing data change streams in real time.</p>
<h3 id="running-minimal-configuration">Running Minimal Configuration:</h3>
<p>Minimal configuration needed to start replicator on localhost with STDOUT applier is:</p>
<pre><code class="YAML">replication_schema:
    name:      'testdb'
    username:  'test_user'
    password:  'test_pass'
    host_pool: ['localhost']

metadata_store:
    username: 'meta_user'
    password: 'meta_pass'
    host:     'localhost'
    database: 'testdb_active_schema'
    file:
        path: '/path/on/disk'

metrics:
    frequency: 10 seconds
    reporters:
        console:
            timeZone: UTC
            output: stdout
</code></pre>

<p>Where 'testdb' is a schema on local mysql instance that is going to be monitored for changes and 'testdb_active_schema' is a empty copy of 'testdb'. By empty copy we mean a copy of the schema containing tables with no data. This copy can be made with following steps:</p>
<p>create new schema named 'testdb_active_schema'.</p>
<pre><code class="SQL">CREATE DATABASE testdb_active_schema;
</code></pre>

<p>dump the schema:</p>
<pre><code>mysqldump --host=localhost --user=test_user --password=test_pass --no-data --single-transaction testdb &gt; schema_dump.sql
</code></pre>

<p>replace 'testdb.' with 'testdb_active_schema.' in schema_dump.sql, for example in vim:</p>
<pre><code class="VIM">%s/testdb\./testdb_active_schema\./g
</code></pre>

<p>then import the schema to testdb_active_schema:</p>
<pre><code>mysql --host=localhost --user=meta_user --password=meta_pass &lt; schema_dump.sql
</code></pre>

<p>then start the replicator:</p>
<pre><code>java -jar mysql-replicator.jar \
    --applier STDOUT \
    --schema testdb \
    --binlog-filename $starting-binlog-file-path \
    --config-path $config-file-path
</code></pre>

<h3 id="additional-configuration-options">Additional Configuration Options</h3>
<p>Replicator configuration is contained in a single YAML file. Additional options are activated by adding them to this config file. The structure of the file with all supported options is:</p>
<pre><code class="YAML">replication_schema:
    name:      'replicated_schema_name'
    username:  'user'
    password:  'pass'
    host_pool: ['host_1', ..., 'host_n']

metadata_store:
    username: 'user'
    password: 'pass'
    host:     'active_schema_host'
    database: 'active_schema_database'
    # The following are options for storing replicator metadata,
    # only one should be used (zookeeper or file)
    zookeeper:
        quorum: ['zk-host1', 'zk-host2']
        path: '/path/in/zookeeper'
    file:
        path: '/path/on/disk'

# Only one applier is needed (HBase or Kafka). If none is specified
# then only STDOUT applier can be used
hbase:
    namespace: 'schema_namespace'
    zookeeper_quorum:  ['hbase-zk1-host', ..., 'hbase-zkN-host']
    # hive-imports is optional
    hive_imports:
        tables: ['sometable']
kafka:
    broker: &quot;kafka-broker-1:port,...,kafka-broken-N:port&quot;
    topic:  topic_name
    # tables to replicate to kafka, can be either a list of tables,
    # or an exlcussion filter
    tables: [&quot;table_1&quot;, ..., &quot;table_N&quot;]
    excludetables: [&quot;exlude_pattern_1&quot;,..., &quot;exclude_pattern_N&quot;]

# mysql-failover is optional
mysql_failover:
    pgtid:
        p_gtid_pattern: $regex_pattern_to_extract_pgtid
        p_gtid_prefix: $prefix_to_add_to_pgtid_query_used_in_orchestrator_url
    # orchestator is optional
    orchestrator:
        username: orchestrator-user-name
        password: orchestrator-password
        url:      http://orchestrator-host/api

metrics:
    frequency: 10 seconds
    reporters:
        # The following are options for metrics reporters,
        # only one should be used (graphite or console)
        graphite:
            namespace: 'graphite.namespace.prefix'
            url: 'graphite_host[:&lt;graphite_port (default is 3002)&gt;]'
        console:
            timeZone: UTC
            output: stdout
</code></pre>

<h4 id="replication-to-kafka">Replication to Kafka</h4>
<p>You need to have a kafka topic specified in the config file. Then you start the replicator:</p>
<pre><code>java -jar mysql-replicator.jar \
    --applier kafka \
    --schema $schema \
    --binlog-filename $binlog-filename \
    --config-path $config-path
</code></pre>

<h4 id="replication-to-hbase">Replication to HBase</h4>
<p>Replication to HBase has two steps needed for setup: </p>
<pre><code>1. First the initial snapshot (hbase copy of mysql tables) needs to be made
2. Then replication can be started
</code></pre>
<p>Initial snapshot is the copy of mysql tables made before the replication to hbase
is started. To make initial snapshot, two steps are performed.</p>
<p>Flush the database to the binlog (using the binlog flusher tool): <a href="https://github.com/mysql-time-machine/replicator/tree/master/binlog-flusher">binlog flusher</a>. After the binlog-flusher finishes the flushing, by default mysql replication is stopped.</p>
<p>Then, the flushed data is replicated to HBase using the replicator
with --initial-snapshot option:</p>
<pre><code>java -jar mysql-replicator.jar \
    --hbase-namespace $hbase-namespace \
    --applier hbase --schema $schema \
    --binlog-filename $first-binlog-filename \
    --config-path $config-path \
    --initial-snapshot
</code></pre>

<p>After the initial snapshot has been made start the mysql replication with:</p>
<pre><code class="SQL">start slave;
</code></pre>

<p>After this command mysql will start to write to binlogs again.</p>
<p>Then start the replicator:</p>
<pre><code>java -jar mysql-replicator.jar \
    --hbase-namespace $hbase-namespace \
    --applier hbase \
    --schema $schema \
    --config-path $config-path
</code></pre>

<h4 id="replicate-to-stdout">Replicate to STDOUT</h4>
<pre><code>java -jar mysql-replicator.jar \
    --applier STDOUT \
    --schema $schema \
    --binlog-filename $binlog-filename \
    --last-binlog-filename $last-binlog-filename-to-process \
    --config-path $config-path
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../snapshotter/" class="btn btn-neutral float-right" title="Snapshotter">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../.." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../.." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../snapshotter/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
